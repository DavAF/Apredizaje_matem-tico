import os
import pandas as pd
from glob import glob

# Ruta donde se encuentran los archivos CSV
ruta = 'C:/Users/davth/Desktop/Proyectos/Bibliotecas'

# Máscara de los archivos desde Enero de 2021
mascara = os.path.join(ruta, 'bibliotecas_prestamos_*_*.csv')

# Busca todos los archivos que coincidan con la máscara
archivos = glob(mascara)

# Lista para almacenar las rutas de los archivos XLSX generados
archivos_xlsx = []

# Verifica si se encontraron archivos
if not archivos:
    print("No se encontraron archivos con la máscara especificada.")
else:
    # Inicializa una lista para almacenar los dataframes para la combinación final
    dataframes = []

    # Recorre todos los archivos y los lee en un dataframe
    for archivo in archivos:
        try:
            print(f"Intentando leer {archivo} con delimitador ';' y motor Python, saltando líneas malas")
            # Lee el archivo con el delimitador correcto, usando el motor 'python' y saltando líneas malas
            df = pd.read_csv(archivo, encoding='utf-8', sep=';', engine='python', on_bad_lines='skip')
        except UnicodeDecodeError:
            # Si falla la codificación utf-8, intenta con ISO-8859-1
            df = pd.read_csv(archivo, encoding='ISO-8859-1', sep=';', engine='python', on_bad_lines='skip')
        except Exception as e:
            print(f"Error al procesar el archivo {archivo}: {e}")
            continue  # Continúa con el siguiente archivo si ocurre un error
        
        # Genera un nombre de archivo para cada CSV convertido a Excel
        nombre_xlsx = archivo.replace('.csv', '.xlsx')
        df.to_excel(nombre_xlsx, index=False)
        
        # Almacena la ruta del archivo generado
        archivos_xlsx.append(nombre_xlsx)
        
        # Añade el dataframe a la lista para la combinación final
        dataframes.append(df)
    
    # Combina todos los dataframes en uno solo si hay dataframes
    if dataframes:
        # Concatenar todos los dataframes
        df_combinado = pd.concat(dataframes, ignore_index=True)

        # Guardar el dataframe combinado en un archivo Excel
        salida_excel_combinado = os.path.join(ruta, 'bibliotecas_prestamos_combinado_final.xlsx')
        df_combinado.to_excel(salida_excel_combinado, index=False)

        print(f"Archivos XLSX individuales generados con éxito. Archivo combinado generado en: {salida_excel_combinado}")
    else:
        print("No se pudo combinar ningún archivo.")
